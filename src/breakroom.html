<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Breakroom</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .room { transition: width 0.45s ease, opacity 0.25s ease; }
    .card { transition: transform 0.25s ease, box-shadow 0.25s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .msg { animation: fadeIn 180ms ease both; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(8px);} to {opacity:1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-gradient-to-br from-yellow-100 via-pink-100 to-blue-100 flex flex-col font-sans">
  <!-- Header -->
  <header class="p-6 text-center bg-white/70 shadow-lg sticky top-0 z-10">
    <h1 class="text-5xl font-extrabold text-purple-700 drop-shadow-sm">üçµ The Breakroom</h1>
    <p class="text-base md:text-lg text-gray-600 mt-1">Pick your vibe: Laugh it out or Vent it out!</p>
  </header>

  <!-- Controls Bar -->
  <section class="px-6 pt-3 max-w-7xl mx-auto w-full">
    <div class="flex flex-wrap items-center gap-3 bg-white/70 rounded-2xl p-3 shadow">
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-700">Display name</label>
        <input id="displayName" class="px-3 py-1.5 rounded-lg border bg-white" placeholder="e.g., Ms. K" />
      </div>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <button id="resetSplit" class="px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300">Reset layout</button>
        <span id="statusDot" class="inline-block w-2 h-2 rounded-full bg-gray-300"></span>
        <span id="statusText" class="text-gray-600">Idle</span>
      </div>
    </div>
  </section>

  <!-- Rooms -->
  <main class="flex-1 w-full max-w-7xl mx-auto px-6 pb-8">
    <div id="roomsWrap" class="flex gap-6 mt-4 h-[calc(100vh-220px)]">

      <!-- Laughter Room -->
      <section id="laughterRoom" class="room w-1/2 bg-yellow-100 rounded-2xl shadow-xl p-5 cursor-pointer overflow-hidden flex flex-col">
        <div class="text-center">
          <h2 class="text-3xl font-extrabold text-yellow-800">üòÇ Laughter Lounge</h2>
          <p class="text-sm text-yellow-900/70">Share the goofy bits of the day</p>
        </div>

        <div class="mt-4 grid grid-rows-[auto_1fr_auto] gap-3 h-full" onclick="event.stopPropagation()">
          <!-- Composer -->
          <div class="card bg-white/80 rounded-xl p-3 flex items-center gap-2">
            <textarea id="laughterInput" class="flex-1 resize-none rounded-lg border p-2" rows="2" placeholder="Share a laugh‚Ä¶"></textarea>
            <button id="sendLaugh" class="shrink-0 px-4 py-2 rounded-lg bg-yellow-500 hover:bg-yellow-600 text-white font-semibold">Post</button>
          </div>

          <!-- Messages -->
          <div id="laughterMessages" class="card bg-white/70 rounded-xl p-3 overflow-y-auto space-y-2">
            <!-- Filled by JS -->
          </div>

          <!-- Tips -->
          <div class="text-xs text-yellow-900/70">Use kind humor. Blur faces in images (images coming later).</div>
        </div>
      </section>

      <!-- Venting Room -->
      <section id="ventingRoom" class="room w-1/2 bg-red-100 rounded-2xl shadow-xl p-5 cursor-pointer overflow-hidden flex flex-col">
        <div class="text-center">
          <h2 class="text-3xl font-extrabold text-red-800">üò§ Venting Room</h2>
          <p class="text-sm text-red-900/70">Say it anonymously, get it off your chest</p>
        </div>

        <div class="mt-4 grid grid-rows-[auto_1fr_auto] gap-3 h-full" onclick="event.stopPropagation()">
          <!-- Composer (anonymous) -->
          <div class="card bg-white/80 rounded-xl p-3 flex items-center gap-2">
            <textarea id="ventingInput" class="flex-1 resize-none rounded-lg border p-2" rows="2" placeholder="Vent it out‚Ä¶ (no names, no identifiers)"></textarea>
            <button id="sendVent" class="shrink-0 px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold">Post</button>
          </div>

          <!-- Messages -->
          <div id="ventingMessages" class="card bg-white/70 rounded-xl p-3 overflow-y-auto space-y-2">
            <!-- Filled by JS -->
          </div>

          <!-- Tips -->
          <div class="text-xs text-red-900/70">Anonymous by design. Be respectful; heavy topics allowed.</div>
        </div>
      </section>

    </div>
  </main>

  <script>
  // ===== CONFIG =====
  const API_BASE = "http://localhost:3000"; // updated port

  // ===== DOM =====
  const laughterRoom = document.getElementById('laughterRoom');
  const ventingRoom  = document.getElementById('ventingRoom');
  const resetSplit   = document.getElementById('resetSplit');
  const laughterBox  = document.getElementById('laughterMessages');
  const ventingBox   = document.getElementById('ventingMessages');
  const laughterInput= document.getElementById('laughterInput');
  const ventingInput = document.getElementById('ventingInput');
  const sendLaughBtn = document.getElementById('sendLaugh');
  const sendVentBtn  = document.getElementById('sendVent');
  const displayNameEl= document.getElementById('displayName');
  const statusDot    = document.getElementById('statusDot');
  const statusText   = document.getElementById('statusText');

  // ===== LAYOUT BEHAVIOR =====
  function expand(which) {
    if (which === 'laughter') {
      laughterRoom.classList.remove('w-1/2');
      ventingRoom.classList.remove('w-1/2');
      laughterRoom.classList.add('w-[70%]');
      ventingRoom.classList.add('w-[30%]');
    } else {
      ventingRoom.classList.remove('w-1/2');
      laughterRoom.classList.remove('w-1/2');
      ventingRoom.classList.add('w-[70%]');
      laughterRoom.classList.add('w-[30%]');
    }
  }
  function resetLayout() {
    laughterRoom.className = 'room w-1/2 bg-yellow-100 rounded-2xl shadow-xl p-5 cursor-pointer overflow-hidden flex flex-col';
    ventingRoom.className  = 'room w-1/2 bg-red-100 rounded-2xl shadow-xl p-5 cursor-pointer overflow-hidden flex flex-col';
  }

  laughterRoom.addEventListener('click', () => expand('laughter'));
  ventingRoom.addEventListener('click',  () => expand('vent'));
  resetSplit.addEventListener('click', resetLayout);

  document.querySelectorAll('textarea, button, input').forEach(el => {
    el.addEventListener('click', e => e.stopPropagation());
  });

  // ===== HELPERS =====
  function setStatus(state) {
    const map = { idle:['bg-gray-300','Idle'], loading:['bg-amber-400','Loading‚Ä¶'], ok:['bg-green-500','Live'], err:['bg-red-500','Error'] };
    const [cls, txt] = map[state] || map.idle;
    statusDot.className = 'inline-block w-2 h-2 rounded-full ' + cls;
    statusText.textContent = txt;
  }

  function msgBubble({ username, message, createdAt }, kind) {
    const wrap = document.createElement('div');
    wrap.className = 'msg p-2 rounded-xl bg-white shadow flex items-start gap-2';
    const badge = document.createElement('span');
    badge.className = 'px-2 py-0.5 rounded-full text-xs ' + (kind==='laughter' ? 'bg-yellow-200 text-yellow-900' : 'bg-red-200 text-red-900');
    badge.textContent = kind === 'laughter' ? 'Laugh' : 'Anon';
    const head = document.createElement('div');
    head.className = 'text-xs text-gray-500';
    const time = new Date(createdAt || Date.now()).toLocaleString();
    head.textContent = (username || (kind==='laughter' ? 'Teacher' : 'Anonymous')) + ' ‚Ä¢ ' + time;
    const body = document.createElement('div');
    body.className = 'text-[15px] text-gray-800';
    body.textContent = message;
    const col = document.createElement('div');
    col.className = 'flex-1';
    col.appendChild(head); col.appendChild(body);
    wrap.appendChild(badge); wrap.appendChild(col);
    return wrap;
  }

  async function loadMessages(room) {
    try {
      setStatus('loading');
      const res = await fetch(`${API_BASE}/api/communityChats/get?roomType=${room}`);
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      const box = room === 'laughter' ? laughterBox : ventingBox;
      box.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'text-sm text-gray-500';
        empty.textContent = 'No posts yet ‚Äî be the first to share!';
        box.appendChild(empty);
      } else {
        data.forEach(m => box.appendChild(msgBubble(m, room)));
        box.scrollTop = box.scrollHeight;
      }
      setStatus('ok');
    } catch (e) {
      console.error(e);
      setStatus('err');
    }
  }

  async function sendMessage(room) {
    const input = room === 'laughter' ? laughterInput : ventingInput;
    const message = (input.value || '').trim();
    if (!message) return;
    const username = room === 'laughter' ? (displayNameEl.value.trim() || 'Teacher') : 'Anonymous';
    try {
      setStatus('loading');
      const res = await fetch(`${API_BASE}/api/communityChats/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomType: room, username, message })
      });
      if (!res.ok) throw new Error('Post failed');
      input.value = '';
      await loadMessages(room);
      setStatus('ok');
    } catch (e) {
      console.error(e);
      setStatus('err');
      alert('Could not post. Is the server running?');
    }
  }

  // Wire buttons
  sendLaughBtn.addEventListener('click', () => sendMessage('laughter'));
  sendVentBtn .addEventListener('click', () => sendMessage('venting'));

  // Initial load
  loadMessages('laughter');
  loadMessages('venting');

  // Auto-refresh
  setInterval(() => {
    loadMessages('laughter');
    loadMessages('venting');
  }, 20000);
</script>

</body>
</html>
