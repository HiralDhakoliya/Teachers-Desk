<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher‚Äôs Desk ‚Äì Calendar</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .top-actions {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  padding: 0 20px;
}
.top-actions button {
  padding: 10px 16px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.top-actions button.logout {
  background: crimson;
}

    .marker {
      width: 6px;
      height: 6px;
      background-color: #673ab7;
      border-radius: 50%;
      margin: 4px auto 0;
    }
  </style>
</head>
<body>
  <div class="top-actions">
  <button onclick="window.location.href='dashboard.html'">‚Üê Back to Dashboard</button>
  <button class="logout" onclick="logout()">Logout</button>
</div>

  <div class="calendar-container">
    <div style="text-align: center; margin-top: 30px;">
      <a href="myschedule.html">
        <button style="background: #10b981; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
          üìã View My Schedule
        </button>
      </a>
    </div>

    <header class="calendar-header">
      <button class="nav-btn" id="prevBtn">‚Üê</button>
      <h1 id="monthYear">Month Year</h1>
      <button class="nav-btn" id="nextBtn">‚Üí</button>
    </header>

    <div class="calendar-grid" id="calendarGrid">
      <div class="day-name">Sun</div>
      <div class="day-name">Mon</div>
      <div class="day-name">Tue</div>
      <div class="day-name">Wed</div>
      <div class="day-name">Thu</div>
      <div class="day-name">Fri</div>
      <div class="day-name">Sat</div>
    </div>
  </div>

  <!-- Floating Modal -->
  <div class="modal" id="eventModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2>Add Class for <span id="selectedDate">Date</span></h2>
      <input type="text" id="inputSubject" placeholder="Subject / Topic" />
      <input type="time" id="inputStart" />
      <input type="time" id="inputEnd" />
      <textarea id="inputNotes" placeholder="Notes / Zoom link..."></textarea>
      <button onclick="saveTask()">Save</button>
    </div>
  </div>

  <script>
    const calendarGrid = document.getElementById("calendarGrid");
    const monthYear = document.getElementById("monthYear");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const email = localStorage.getItem("email");
    if (!email) {
      alert("Please login first.");
      window.location.href = "login.html";
    }

    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];

    let currentDate = new Date();
    let selectedDateKey = "";
    let monthTasks = new Set();

    async function renderCalendar(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      const monthStr = String(month + 1).padStart(2, '0');
      await fetchTasksForMonth(year, monthStr);

      monthYear.textContent = `${monthNames[month]} ${year}`;

      const headers = Array.from(calendarGrid.children).slice(0, 7);
      calendarGrid.innerHTML = '';
      headers.forEach(h => calendarGrid.appendChild(h));

      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'day disabled';
        calendarGrid.appendChild(empty);
      }

      for (let d = 1; d <= lastDate; d++) {
        const day = document.createElement('div');
        day.className = 'day';
        day.textContent = d;

        const mm = String(month + 1).padStart(2, '0');
        const dd = String(d).padStart(2, '0');
        const key = `${year}-${mm}-${dd}`;

        if (monthTasks.has(key)) {
          const marker = document.createElement("div");
          marker.className = "marker";
          day.appendChild(marker);
        }

        day.onclick = () => openModal(d, month, year);
        calendarGrid.appendChild(day);
      }
    }

    async function fetchTasksForMonth(year, monthStr) {
      try {
        const res = await fetch(`/api/calendar-tasks-all?email=${encodeURIComponent(email)}`);
        const data = await res.json();
        monthTasks = new Set();
        window.allTasks = data;

        for (let task of data) {
          if (task.date.startsWith(`${year}-${monthStr}`)) {
            monthTasks.add(task.date);
          }
        }
      } catch (err) {
        console.error("Error fetching month tasks:", err);
      }
    }

    async function openModal(day, monthIndex, year) {
      const month = String(monthIndex + 1).padStart(2, '0');
      const dayStr = String(day).padStart(2, '0');
      selectedDateKey = `${year}-${month}-${dayStr}`;

      const formatted = `${monthNames[monthIndex]} ${day}, ${year}`;
      document.getElementById("selectedDate").innerText = formatted;

      const modal = document.getElementById("eventModal");
      const tasks = window.allTasks?.filter(t => t.date === selectedDateKey) || [];

      let html = '';
      if (tasks.length) {
        html += "<h4>Existing Tasks:</h4><ul>";
        tasks.forEach(task => {
          html += `
            <li>
              <b>${task.subject}</b> (${task.start} - ${task.end})
              <br/><small>${task.notes}</small>
              <br/>
              <button onclick="deleteTask('${task._id}')">‚ùå Delete</button>
            </li><hr/>`;
        });
        html += "</ul>";
      }

      document.querySelector(".modal-content").insertAdjacentHTML("afterbegin", html);
      modal.style.display = "flex";
    }

    function closeModal() {
      document.getElementById("eventModal").style.display = "none";
      document.querySelector(".modal-content").innerHTML = `
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2>Add Class for <span id="selectedDate">Date</span></h2>
        <input type="text" id="inputSubject" placeholder="Subject / Topic" />
        <input type="time" id="inputStart" />
        <input type="time" id="inputEnd" />
        <textarea id="inputNotes" placeholder="Notes / Zoom link..."></textarea>
        <button onclick="saveTask()">Save</button>`;
    }

    async function deleteTask(id) {
      try {
        const res = await fetch(`/api/calendar-tasks/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert("üóëÔ∏è Deleted!");
          closeModal();
          renderCalendar(currentDate);
        }
      } catch (err) {
        console.error("Delete failed", err);
      }
    }

    async function saveTask() {
      const subject = document.getElementById("inputSubject").value;
      const start = document.getElementById("inputStart").value;
      const end = document.getElementById("inputEnd").value;
      const notes = document.getElementById("inputNotes").value;

      if (!subject || !start || !end) {
        alert("Please fill all fields.");
        return;
      }

      const task = { date: selectedDateKey, subject, start, end, notes, email };

      try {
        const res = await fetch("/api/calendar-tasks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(task)
        });

        if (res.ok) {
          alert("‚úÖ Task Saved!");
          closeModal();
          renderCalendar(currentDate);
        }
      } catch (err) {
        console.error("Error saving task:", err);
      }
    }

    prevBtn.onclick = () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate);
    };

    nextBtn.onclick = () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate);
    };

    renderCalendar(currentDate);
    function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

  </script>

</body>
</html>
